<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Gappkar Online</title>
  <link rel="icon" type="image/jpeg" href="your-icon.jpg">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
  <style>
    /* ===== VARIABLES WITH UPDATED RED GRADIENT THEME ===== */
    :root {
      --bg-gradient: linear-gradient(180deg, #000000 0%, #1a0000 50%, #000000 100%);
      --bg-dark: #000000;
      --bg-light: #111111;
      --text-dark: #ffffff;
      --text-light: #000000;
      --accent: #df1317;
      --accent-light: #e63946;
      --accent-gradient: linear-gradient(135deg, #df1317 0%, #e63946 50%, #ff6b6b 100%);
      --border-gradient: linear-gradient(180deg, #df1317 0%, #e63946 50%, #000000 100%);
      --gray: #888888;
      --border-radius: 15px;
      --border-thin: 2px solid;
      --system-bg: #222222;
      --system-text: #aaaaaa;
      --modal-bg: rgba(0, 0, 0, 0.9);
      --shadow: 0 4px 15px rgba(223, 19, 23, 0.3);
      --card-hover: 0 6px 20px rgba(223, 19, 23, 0.4);
    }
    
    [data-theme="dark"] {
      --bg-gradient: linear-gradient(180deg, #ffffff 0%, #f0f0f0 50%, #ffffff 100%);
      --bg-dark: #ffffff;
      --bg-light: #f5f5f5;
      --text-dark: #000000;
      --text-light: #ffffff;
      --border-gradient: linear-gradient(180deg, #df1317 0%, #e63946 50%, #ffffff 100%);
      --system-bg: #f0f0f0;
      --system-text: #666666;
      --modal-bg: rgba(255, 255, 255, 0.9);
    }
    
    /* ===== RESET & BASE STYLES ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }
    
    body {
      font-family: 'DotGothic16', monospace;
      background: var(--bg-gradient);
      color: var(--text-dark);
      letter-spacing: 0.5px;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }
    
    /* ===== MAIN CONTAINER ===== */
    .app-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 0;
    }
    
    .main-container {
      width: 100%;
      max-width: 400px;
      background: var(--bg-gradient);
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    /* ===== GRADIENT BORDER HELPER ===== */
    .gradient-border {
      position: relative;
    }
    
    .gradient-border::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: inherit;
      padding: 2px;
      background: var(--border-gradient);
      -webkit-mask: 
        linear-gradient(#fff 0 0) content-box, 
        linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask: 
        linear-gradient(#fff 0 0) content-box, 
        linear-gradient(#fff 0 0);
      mask-composite: exclude;
      pointer-events: none;
    }
    
    /* ===== APP HEADER ===== */
    .app-header {
      background: var(--bg-dark);
      padding: 30px 20px;
      text-align: center;
      position: relative;
      border-bottom: 1px solid #333;
    }
    
    .chat-active .app-header {
      display: none !important;
    }
    
    .theme-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      background: transparent;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-dark);
      transition: all 0.3s ease;
      font-family: 'DotGothic16', monospace;
    }
    
    .theme-toggle.gradient-border {
      border: none;
    }
    
    .theme-toggle:hover {
      background: var(--accent-gradient);
      color: white;
      transform: scale(1.1);
      box-shadow: var(--shadow);
    }
    
    .logo-section {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 20px;
  margin-top: 10px;
  justify-content: center;
}

.logo-icon {
  width: 70px;
  height: 70px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--accent-gradient);
  font-weight: 700;
  font-size: 36px;
  color: white;
  overflow: hidden;
  box-shadow: var(--card-hover);
  position: relative;
  font-family: 'DotGothic16', monospace;
  flex-shrink: 0;
}

.logo-icon::after {
  content: "";
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
  transform: rotate(45deg);
  animation: shine 3s infinite;
}

@keyframes shine {
  0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
  50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
  100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
}

.logo-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 14px;
}

.app-text-section {
  display: block;
  text-align: left;
}

.logo-section {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 20px;
  margin-top: 10px;
  justify-content: center;
}

.app-text-section {
  display: flex;
  flex-direction: column;
  justify-content: center;
  text-align: left;
}

.app-title {
  font-size: 60px;
  font-weight: 700;
  letter-spacing: 3px;
  text-transform: lowercase;
  background: var(--accent-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-shadow: 0 0 30px rgba(223, 19, 23, 0.5);
  font-family: 'DotGothic16', monospace;
  line-height: 1;
  margin: 0;
  padding: 0;
  text-align: left;
}

.app-subtitle {
  font-size: 12px;
  color: var(--gray);
  font-weight: 300;
  letter-spacing: 0.8px;
  font-family: 'DotGothic16', monospace;
  line-height: 1.2;
  opacity: 0.9;
  margin-top: 4px;
  text-align: left;
}




/*.app-subtitle {
  font-size: 8px;
  color: var(--gray);
  font-weight: 300;
  letter-spacing: 0.8px;
  font-family: 'DotGothic16', monospace;
  line-height: 1.2;
  opacity: 0.9;
  margin-top: 8px;
  padding: -200;
  display: blok;
  width: 100%;
  clear: both;
}


    /* ===== VIEW MANAGEMENT ===== */
    .view {
      display: flex;
      flex-direction: column;
    }
    
    .view.hidden {
      display: none !important;
    }
    
    /* ===== ENHANCED JOIN VIEW ===== */
    #joinView {
      padding: 30px 24px;
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-gradient);
    }
    
    .section-header {
      text-align: center;
      margin-bottom: 40px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(223, 19, 23, 0.1), rgba(230, 57, 70, 0.05));
      border-radius: 20px;
      border: 1px solid rgba(223, 19, 23, 0.2);
      position: relative;
      overflow: hidden;
    }
    
    .section-header::before {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 2px;
      background: var(--accent-gradient);
      animation: slideIn 2s infinite;
    }
    
    @keyframes slideIn {
      0% { left: -100%; }
      50% { left: 100%; }
      100% { left: -100%; }
    }
    
    .section-icon {
      font-size: 40px;
      margin-bottom: 15px;
      animation: bounce 2s infinite;
      font-family: 'DotGothic16', monospace;
    }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }
    
    .section-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 10px;
      text-transform: uppercase;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 2px;
      font-family: 'DotGothic16', monospace;
    }
    
    .section-description {
      color: var(--gray);
      font-size: 16px;
      font-weight: 400;
      letter-spacing: 0.5px;
      font-family: 'DotGothic16', monospace;
    }
    
    .form-group {
      margin-bottom: 25px;
    }
    
    .form-label {
      display: block;
      font-weight: 700;
      margin-bottom: 10px;
      font-size: 15px;
      color: var(--text-dark);
      text-transform: uppercase;
      letter-spacing: 1px;
      font-family: 'DotGothic16', monospace;
    }
    
    .form-input {
      width: 100%;
      padding: 16px 20px;
      border: none;
      border-radius: 20px;
      font-size: 16px;
      font-family: 'DotGothic16', monospace;
      background: var(--system-bg);
      color: var(--text-dark);
      outline: none;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    .form-input.gradient-border {
      background: var(--system-bg);
    }
    
    .form-input:focus {
      box-shadow: 0 0 0 4px rgba(223, 19, 23, 0.2);
      transform: translateY(-2px);
      background: #333333;
    }
    
    .form-input::placeholder {
      color: var(--gray);
      font-weight: 400;
    }
    
    .location-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    #locationStatus {
      padding: 15px;
      border-radius: 15px;
      text-align: center;
      margin-top: 15px;
      font-size: 13px;
      border: 2px solid transparent;
      font-weight: 500;
      font-family: 'DotGothic16', monospace;
    }
    
    #locationStatus.success {
      background: linear-gradient(135deg, rgba(40, 167, 69, 0.2), rgba(32, 201, 151, 0.1));
      color: #20c997;
      border-color: rgba(32, 201, 151, 0.3);
    }
    
    #locationStatus.error {
      background: linear-gradient(135deg, rgba(220, 53, 69, 0.2), rgba(255, 193, 203, 0.1));
      color: #ff6b6b;
      border-color: rgba(220, 53, 69, 0.3);
    }
    
    /* ===== ENHANCED BUTTON STYLING ===== */
    .btn {
      width: 100%;
      padding: 16px 18px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      cursor: pointer;
      border: none;
      font-family: 'DotGothic16', monospace;
      transition: all 0.4s ease;
      position: relative;
      overflow: hidden;
      letter-spacing: 1px;
    }
    
    .btn::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.5s ease;
    }
    
    .btn:hover::before {
      width: 300px;
      height: 300px;
    }
    
    .btn-location, .btn-success {
      background: var(--system-bg);
      color: var(--text-dark);
      box-shadow: var(--shadow);
      position: relative;
      z-index: 1;
    }
    
    .btn-location.gradient-border, .btn-success.gradient-border {
      background: var(--system-bg);
    }
    
    .btn-location:hover, .btn-success:hover {
      transform: translateY(-4px);
      box-shadow: var(--card-hover);
      background: var(--accent-gradient);
      color: white;
    }
    
    .btn-location:active, .btn-success:active {
      transform: translateY(-1px);
    }
    
    /* Pulse animation for main action button */
    .btn-success {
      animation: pulse-glow 3s infinite;
    }
    
    @keyframes pulse-glow {
      0% { box-shadow: var(--shadow); }
      50% { box-shadow: 0 0 20px rgba(223, 19, 23, 0.6); }
      100% { box-shadow: var(--shadow); }
    }
    
    /* ===== CHAT VIEW ===== */
    #chatsView {
      display: none;
      flex-direction: column;
      background: var(--bg-gradient);
      height: 100vh;
      overflow: hidden;
    }
    
    #chatsView:not(.hidden) {
      display: flex !important;
    }
    
    .chat-header {
      background: var(--bg-dark);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid #333;
      flex-shrink: 0;
    }
    
    .back-button, .header-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--system-bg);
      font-size: 16px;
      color: var(--text-dark);
      transition: all 0.3s ease;
      border: none;
      font-family: 'DotGothic16', monospace;
    }
    
    .back-button.gradient-border, .header-btn.gradient-border {
      background: var(--system-bg);
    }
    
    .back-button:hover, .header-btn:hover {
      background: var(--accent-gradient);
      color: white;
      transform: scale(1.1);
    }
    
    .chat-header-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .header-logo-section {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }
    
    .header-logo-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--accent-gradient);
      font-weight: 600;
      font-size: 16px;
      color: white;
      flex-shrink: 0;
      overflow: hidden;
      font-family: 'DotGothic16', monospace;
    }
    
    .header-logo-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
    }
    
    .header-app-info {
      flex: 1;
      min-width: 0;
    }
    
    .header-app-name {
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 1px;
      line-height: 1.2;
      font-family: 'DotGothic16', monospace;
    }
    
    .header-room-info {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--gray);
      margin-top: 2px;
      font-family: 'DotGothic16', monospace;
    }
    
    .room-indicator {
      background: var(--accent-gradient);
      color: white;
      padding: 3px 8px;
      border-radius: 8px;
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-family: 'DotGothic16', monospace;
    }
    
    .online-dot {
      width: 6px;
      height: 6px;
      background: var(--accent);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* ===== FIND VIEW GRID ===== */
    .find-view {
      display: flex;
      flex-direction: column;
      padding: 0;
      flex-grow: 1;
      background: var(--bg-gradient);
    }
    
    #findMenuView {
      align-items: stretch;
      justify-content: flex-start;
      text-align: left;
    }
    
    .find-menu-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .find-menu-btn {
      position: relative;
      background: var(--system-bg);
      border-radius: var(--border-radius);
      padding: 25px 15px;
      text-align: center;
      color: var(--text-dark);
      text-decoration: none;
      transition: all 0.3s ease;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 12px;
      border: none;
      overflow: hidden;
      cursor: pointer;
      font-family: 'DotGothic16', monospace;
    }
    
    .find-menu-btn.gradient-border {
      background: var(--system-bg);
    }
    
    .find-menu-btn:hover {
      transform: translateY(-5px);
      box-shadow: var(--card-hover);
    }
    
    .find-menu-btn.primary {
      background: var(--accent-gradient);
      color: white;
    }
    
    .find-menu-btn.primary::before {
      display: none;
    }
    
    .find-menu-icon {
      font-size: 32px;
      margin-bottom: 5px;
      position: relative;
      z-index: 1;
      font-family: 'DotGothic16', monospace;
    }
    
    .find-menu-text {
      font-size: 14px;
      font-weight: 600;
      position: relative;
      z-index: 1;
      text-transform: uppercase;
      font-family: 'DotGothic16', monospace;
    }
    
    /* ===== PROMOTIONAL BUTTONS ===== */
    .promo-buttons {
      display: flex;
      justify-content: space-around;
      padding: 0 20px 20px;
      gap: 10px;
    }
    
    .promo-btn {
      flex: 1;
      padding: 10px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-align: center;
      color: white;
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      background: var(--accent-gradient);
      box-shadow: var(--shadow);
      font-family: 'DotGothic16', monospace;
    }
    
    .promo-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--card-hover);
    }
    
    /* ===== USER LIST ===== */
    .user-list {
      list-style: none;
      overflow-y: auto;
      flex-grow: 1;
      padding: 0 20px;
    }
    
    .user-card {
      display: flex;
      align-items: center;
      background: var(--system-bg);
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 12px;
      transition: all 0.3s ease;
    }
    
    .user-card.gradient-border {
      background: var(--system-bg);
    }
    
    .user-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    
    .profile-pic {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 15px;
      border: 2px solid var(--accent);
    }
    
    .user-info h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 4px;
      font-family: 'DotGothic16', monospace;
    }
    
    .user-info p {
      font-size: 12px;
      color: var(--gray);
      font-family: 'DotGothic16', monospace;
    }
    
    .search-bar {
      width: calc(100% - 40px);
      margin: 0 20px 20px;
      padding: 12px 20px;
      font-size: 14px;
      border-radius: 25px;
      border: none;
      background: var(--system-bg);
      outline: none;
      font-family: 'DotGothic16', monospace;
      color: var(--text-dark);
      transition: all 0.3s ease;
    }
    
    .search-bar.gradient-border {
      background: var(--system-bg);
    }
    
    .search-bar:focus {
      box-shadow: 0 0 0 3px rgba(223, 19, 23, 0.2);
      transform: translateY(-1px);
    }
    
    /* ===== MESSAGE STYLING ===== */
    #messageList {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: transparent;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    
    .message {
      display: flex;
      width: 100%;
      animation: messageSlideIn 0.3s ease;
    }
    
    @keyframes messageSlideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .message-bubble {
      border-radius: 18px;
      padding: 12px 16px;
      font-size: 14px;
      word-wrap: break-word;
      max-width: 75%;
      position: relative;
      line-height: 1.4;
      font-family: 'DotGothic16', monospace;
    }
    
    .message.sent {
      justify-content: flex-end;
    }
    
    .message.sent .message-bubble {
      background: var(--accent-gradient);
      color: white;
    }
    
    .message.received {
      justify-content: flex-start;
    }
    
    .message.received .message-bubble {
      background: var(--system-bg);
      color: var(--text-dark);
    }
    
    .message.system {
      justify-content: center;
    }
    
    .message.system .message-bubble {
      background: var(--system-bg);
      color: var(--gray);
      border: 1px dashed var(--gray);
      font-size: 12px;
      max-width: 90%;
      text-align: center;
    }
    
    .message-time {
      font-size: 10px;
      opacity: 0.7;
      margin-top: 4px;
      font-family: 'DotGothic16', monospace;
    }
    
    .sender-name {
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--accent);
      font-family: 'DotGothic16', monospace;
    }
    
    .message-location {
      font-size: 10px;
      opacity: 0.7;
      margin-top: 2px;
      font-family: 'DotGothic16', monospace;
    }
    
    .message-info {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      max-width: 75%;
    }
    
    /* ===== CHAT INPUT AREA ===== */
    .chat-input-area {
      flex-shrink: 0;
      border-top: 1px solid #333;
      background: var(--bg-dark);
    }
    
    .input-row {
      padding: 15px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .expand-btn {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      border: none;
      background: var(--accent-gradient);
      cursor: pointer;
      font-size: 20px;
      color: white;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
      font-family: 'DotGothic16', monospace;
    }
    
    .expand-btn:hover {
      transform: scale(1.1);
    }
    
    .expand-btn.active {
      transform: rotate(45deg) scale(1.1);
    }
    
    .message-input {
      flex: 1;
      background: var(--system-bg);
      border: none;
      border-radius: 25px;
      padding: 12px 20px;
      color: var(--text-dark);
      font-size: 14px;
      font-family: 'DotGothic16', monospace;
      outline: none;
      transition: all 0.3s ease;
    }
    
    .message-input:focus {
      box-shadow: 0 0 0 2px rgba(223, 19, 23, 0.3);
    }
    
    .message-input::placeholder {
      color: var(--gray);
    }
    
    .send-button {
      background: var(--accent-gradient);
      border: none;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      color: white;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
      font-family: 'DotGothic16', monospace;
    }
    
    .send-button:hover {
      transform: scale(1.1);
    }
    
    /* ===== EXPANDABLE OPTIONS ===== */
    .expand-options {
      display: flex;
      justify-content: space-around;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
      padding: 0 20px;
      border-bottom: 1px solid transparent;
    }
    
    .expand-options.visible {
      max-height: 120px;
      padding: 15px 20px;
      border-bottom: 1px solid #333;
    }
    
    .expand-option-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      background: none;
      border: none;
      cursor: pointer;
      font-family: 'DotGothic16', monospace;
      font-size: 12px;
      color: var(--gray);
      transition: all 0.3s ease;
    }
    
    .expand-option-btn .icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--system-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: var(--text-dark);
      transition: all 0.3s ease;
    }
    
    .expand-option-btn .icon.gradient-border {
      background: var(--system-bg);
    }
    
    .expand-option-btn:hover .icon {
      background: var(--accent-gradient);
      color: white;
      transform: scale(1.1);
    }
    
    .expand-option-btn:hover {
      color: var(--accent);
    }
    
    /* ===== FEATURE PANELS ===== */
    .feature-panel {
      background: var(--bg-dark);
      padding: 0;
      display: flex;
      flex-direction: column;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-in-out;
    }
    
    .feature-panel.visible {
      max-height: 300px;
      border-top: 1px solid #333;
    }
    
    .feature-panel-header {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #333;
      flex-shrink: 0;
    }
    
    .feature-panel-title {
      flex-grow: 1;
      font-weight: 600;
      color: var(--text-dark);
      font-size: 16px;
      font-family: 'DotGothic16', monospace;
    }
    
    .feature-panel-close-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--system-bg);
      color: var(--text-dark);
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'DotGothic16', monospace;
    }
    
    .feature-panel-close-btn.gradient-border {
      background: var(--system-bg);
    }
    
    .feature-panel-close-btn:hover {
      background: var(--accent-gradient);
      color: white;
    }
    
    .feature-panel-content {
      padding: 20px;
      overflow-y: auto;
      flex-grow: 1;
    }
    
    .feature-search-bar {
      width: 100%;
      padding: 12px 16px;
      border-radius: 20px;
      border: none;
      background: var(--system-bg);
      font-size: 14px;
      font-family: 'DotGothic16', monospace;
      margin-bottom: 16px;
      outline: none;
      color: var(--text-dark);
      transition: all 0.3s ease;
    }
    
    .feature-search-bar.gradient-border {
      background: var(--system-bg);
    }
    
    .feature-search-bar:focus {
      box-shadow: 0 0 0 2px rgba(223, 19, 23, 0.3);
    }
    
    #stickerGrid, #gif-results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 10px;
    }
    
    .sticker-item, .gif-item {
      width: 100%;
      aspect-ratio: 1 / 1;
      background: var(--system-bg);
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    .sticker-item.gradient-border, .gif-item.gradient-border {
      background: var(--system-bg);
    }
    
    .sticker-item:hover, .gif-item:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow);
    }
    
    .sticker-item img, .gif-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    #audioList {
      list-style: none;
    }
    
    .audio-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-radius: 12px;
      cursor: pointer;
      margin-bottom: 8px;
      background: var(--system-bg);
      transition: all 0.3s ease;
    }
    
    .audio-item.gradient-border {
      background: var(--system-bg);
    }
    
    .audio-item:hover {
      background: var(--accent-gradient);
      color: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    
    .audio-item .play-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: var(--accent-gradient);
      color: white;
      font-size: 14px;
      margin-right: 12px;
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.3s ease;
      font-family: 'DotGothic16', monospace;
    }
    
    .audio-item .play-btn:hover {
      transform: scale(1.1);
    }
    
    .audio-item .audio-name {
      font-size: 14px;
      font-weight: 500;
      font-family: 'DotGothic16', monospace;
    }
    
    .chat-audio-play-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--accent-gradient);
      color: white;
      cursor: pointer;
      font-size: 12px;
      flex-shrink: 0;
      transition: all 0.3s ease;
      font-family: 'DotGothic16', monospace;
    }
    
    .chat-audio-play-btn:hover {
      transform: scale(1.1);
    }
    
    /* ===== MODAL STYLING ===== */
    .room-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: var(--modal-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .room-modal.show {
      opacity: 1;
      visibility: visible;
    }
    
    .room-modal-content {
      background: var(--bg-dark);
      border-radius: 20px;
      padding: 30px;
      max-width: 350px;
      width: 90%;
      position: relative;
      transform: scale(0.9);
      transition: transform 0.3s ease;
      box-shadow: var(--card-hover);
    }
    
    .room-modal-content.gradient-border {
      background: var(--bg-dark);
    }
    
    .room-modal.show .room-modal-content {
      transform: scale(1);
    }
    
    .room-modal-header {
      text-align: center;
      margin-bottom: 24px;
    }
    
    .room-modal-title {
      font-size: 20px;
      font-weight: 600;
      text-transform: uppercase;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
      font-family: 'DotGothic16', monospace;
    }
    
    .room-modal-description {
      font-size: 14px;
      color: var(--gray);
      font-family: 'DotGothic16', monospace;
    }
    
    .room-modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: var(--system-bg);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: var(--text-dark);
      transition: all 0.3s ease;
      font-family: 'DotGothic16', monospace;
    }
    
    .room-modal-close.gradient-border {
      background: var(--system-bg);
    }
    
    .room-modal-close:hover {
      background: var(--accent-gradient);
      color: white;
    }
    
    .room-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .btn-room {
      flex: 1;
      padding: 14px;
      border-radius: 15px;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      cursor: pointer;
      border: none;
      font-family: 'DotGothic16', monospace;
      background: var(--system-bg);
      color: var(--text-dark);
      transition: all 0.3s ease;
    }
    
    .btn-room.gradient-border {
      background: var(--system-bg);
    }
    
    .btn-room:hover {
      background: var(--accent-gradient);
      color: white;
      transform: translateY(-2px);
    }
    
    .btn-room.primary {
      background: var(--accent-gradient);
      color: white;
    }
    
    .btn-room.primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--card-hover);
    }
    
    /* ===== LOADING SPINNER ===== */
    .loader {
      margin: 40px auto;
      border: 4px solid #333;
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ===== MOBILE RESPONSIVENESS ===== */
    @media (max-width: 480px) {
      html {
        height: 100%;
        height: -webkit-fill-available;
      }
      
      body {
        height: 100%;
        height: -webkit-fill-available;
        overflow: hidden;
        position: fixed;
        width: 100%;
      }
      
      .app-container {
        height: 100%;
        height: -webkit-fill-available;
        padding: 0;
        align-items: stretch;
      }
      
      .main-container {
        width: 100%;
        height: 100%;
        height: -webkit-fill-available;
        border-radius: 0;
        border: none;
        max-width: none;
      }
      
      #chatsView:not(.hidden) {
        display: flex !important;
        flex-direction: column;
        height: 100%;
        height: -webkit-fill-available;
        position: relative;
      }
      
      .chat-header {
        flex-shrink: 0;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      
      #messageList {
        flex: 1;
        overflow-y: auto;
        min-height: 0;
        padding-bottom: 20px;
      }
      
      .chat-input-area {
        flex-shrink: 0;
        position: sticky;
        bottom: 0;
        z-index: 100;
        transition: transform 0.3s ease;
      }
      
      body.keyboard-visible .chat-input-area {
        transform: translateY(0);
      }
      
      body.keyboard-visible #messageList {
        padding-bottom: 80px;
      }
      
      .find-menu-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        padding: 15px;
      }
      
      .find-menu-btn {
        min-height: 100px;
        padding: 20px 10px;
      }
      
      .app-header {
        padding: 25px 15px;
      }
      
      .section-header {
        padding: 15px;
        margin-bottom: 30px;
      }
      
      .section-title {
        font-size: 22px;
      }
      
      .app-title {
        font-size: 28px;
      }
    }
    
    /* iOS Safari specific fixes */
    @supports (-webkit-touch-callout: none) {
      @media (max-width: 480px) {
        body {
          height: -webkit-fill-available;
        }
        .app-container,
        .main-container,
        #chatsView:not(.hidden) {
          height: -webkit-fill-available;
        }
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="main-container" id="mainContainer">
      <div class="app-header">
        <button class="theme-toggle gradient-border" id="themeToggle" aria-label="Toggle theme">
          <span id="themeIcon">DIM</span>
        </button>
        <div class="logo-section">
          <div class="logo-icon">
            <img src="your-icon.jpg" alt="Gappkar Logo" class="logo-image" onerror="this.style.display='none'; this.parentNode.innerHTML='G';">
          </div>
          <h1 class="app-title">gappkar</h1>
         
          
        </div>
      </div>
      
      <div id="joinView" class="view active">
        <div class="section-header">
          
          <h2 class="section-title">Join the Chat</h2>
          <p class="section-description">Enter your info to start your gapping adventure</p>
        </div>
        <div class="form-group">
          <label class="form-label" for="usernameInput">üë§ Name</label>
          <input type="text" id="usernameInput" class="form-input gradient-border" placeholder="Enter your display name" maxlength="30" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="ageInput">üéÇ Age</label>
          <input type="number" id="ageInput" class="form-input gradient-border" placeholder="Enter your age" min="13" max="99" required>
        </div>
        <div class="form-group">
          <label class="form-label">üìç Location</label>
          <div class="location-options">
            <button type="button" class="btn btn-location gradient-border" id="getLocationBtn">üìç Get My Area</button>
            <input type="text" id="locationInput" class="form-input gradient-border" placeholder="Or enter your city manually" style="margin-top: 15px;">
          </div>
        </div>
        <button type="button" class="btn btn-success gradient-border" id="joinButton">üöÄ Start Gapping</button>
        <div id="locationStatus"></div>
      </div>
      
      <div id="chatsView" class="view hidden">
        <div class="chat-header">
          <button class="back-button gradient-border" id="backButton">‚Üê</button>
          <div class="chat-header-info">
            <div class="header-logo-section">
              <div class="header-logo-icon">
                <img src="your-icon.jpg" alt="Gappkar Logo" class="header-logo-image" onerror="this.style.display='none'; this.parentNode.innerHTML='G';">
              </div>
              <div class="header-app-info">
                <div class="header-app-name">gappkar</div>
                <div class="header-room-info">
                  <span class="room-indicator" id="roomIndicator">Local Chat</span>
                  <span class="online-dot"></span>
                  <span id="peopleCount">connecting...</span>
                </div>
              </div>
            </div>
          </div>
          <button class="header-btn gradient-border" id="findBtn" title="Find Users">
            <img src="find user icon.png" alt="Find User" style="width: 20px; height: 20px;" onerror="this.innerHTML='üë§'">
          </button>
          <button class="header-btn gradient-border" id="createRoomBtn" title="Create/Join Room">
            <img src="create-join room.png" alt="Create/Join Room" style="width: 20px; height: 20px;" onerror="this.innerHTML='üè†'">
          </button>
        </div>
        <div id="messageList"></div>
        
        <!-- Enhanced Chat Input Area -->
        <div class="chat-input-area">
            <!-- Sticker Panel -->
            <div id="stickerPanel" class="feature-panel">
                <div class="feature-panel-header">
                    <div class="feature-panel-title">Stickers</div>
                    <button class="feature-panel-close-btn gradient-border" data-panel="stickerPanel">√ó</button>
                </div>
                <div class="feature-panel-content">
                    <input type="text" id="sticker-search-input" class="feature-search-bar gradient-border" placeholder="Search stickers...">
                    <div id="stickerGrid"></div>
                </div>
            </div>

            <!-- Audio Panel -->
            <div id="audioPanel" class="feature-panel">
                <div class="feature-panel-header">
                    <div class="feature-panel-title">Sounds</div>
                    <button class="feature-panel-close-btn gradient-border" data-panel="audioPanel">√ó</button>
                </div>
                <div class="feature-panel-content">
                    <input type="text" class="feature-search-bar gradient-border" placeholder="Search sounds...">
                    <ul id="audioList"></ul>
                </div>
            </div>

            <!-- GIF Panel -->
            <div id="gifPanel" class="feature-panel">
                 <div class="feature-panel-header">
                    <div class="feature-panel-title">GIFs</div>
                    <button class="feature-panel-close-btn gradient-border" data-panel="gifPanel">√ó</button>
                </div>
                <div class="feature-panel-content">
                    <input type="text" id="gif-search-input" class="feature-search-bar gradient-border" placeholder="Search for GIFs...">
                    <div id="gif-results-grid"></div>
                </div>
            </div>

            <!-- Expandable Options Menu -->
            <div id="expandOptions" class="expand-options">
                <button class="expand-option-btn" id="gifOptionBtn">
                  <span class="icon gradient-border">
                    <img src="gifs icon.png" alt="GIFs" style="width: 28px; height: 28px;" onerror="this.innerHTML='üé¨'">
                  </span> 
                  GIF
                </button>

                <button class="expand-option-btn" id="audioOptionBtn">
                  <span class="icon gradient-border">
                    <img src="audio sound icon.png" alt="Audio" style="width: 28px; height: 28px;" onerror="this.innerHTML='üîä'">
                  </span> 
                  Sounds
                </button>

                <button class="expand-option-btn" id="stickerOptionBtn">
                  <span class="icon gradient-border">
                    <img src="sticker icon.png" alt="Stickers" style="width: 28px; height: 28px;" onerror="this.innerHTML='üòÄ'">
                  </span> 
                  Sticker
                </button>
            </div>

            <!-- Main Input Row -->
            <div class="input-row">
                <button class="expand-btn" id="expandBtn">+</button>
                <input type="text" class="message-input" id="messageInput" placeholder="Type a message..." autocomplete="off">
                <button class="send-button" id="sendButton">‚û§</button>
            </div>
        </div>
      </div>

      <!-- Find Menu View -->
      <div id="findMenuView" class="view find-view hidden">
        <div class="chat-header">
          <button class="back-button gradient-border" id="findMenuBackBtn">‚Üê</button>
          <div class="chat-header-info">
              <div class="header-app-name">Find Users</div>
          </div>
        </div>
        <div style="padding: 24px;">
            <h2 style="text-align: center; margin-bottom: 10px; color: var(--text-dark); font-family: 'DotGothic16', monospace;">Find Connections</h2>
            <p style="text-align: center; color: var(--gray); margin-bottom: 30px; font-family: 'DotGothic16', monospace;">Discover new people on Gappkar</p>
            
            <!-- Grid Layout for Find Buttons -->
            <div class="find-menu-grid">
              <button class="find-menu-btn primary" id="findAccountsBtn">
                  <span class="find-menu-icon">
                      <!-- Replaced emoji with the 'person' icon -->
                      <i class="search pearson.png">person</i>
                  </span>
                  <span class="find-menu-text">Find gappars</span>
              </button>
              <button class="find-menu-btn gradient-border" id="nearbyBtn">
                  <span class="find-menu-icon">
                      <!-- Replaced emoji with the 'location_on' icon -->
                      <i class="nearby location.png">location_on</i>
                  </span>
                  <span class="find-menu-text">Nearby</span>
              </button>
          </div>
            
            <!-- Promotional Buttons -->
            <div class="promo-buttons">
                <button class="promo-btn">Feedback</button>
                <button class="promo-btn">Instagram</button>
                <button class="promo-btn">Update App</button>
            </div>
        </div>
      </div>

      <!-- Nearby Users View -->
      <div id="nearbyView" class="view find-view hidden">
        <div class="chat-header">
          <button class="back-button gradient-border" id="nearbyBackBtn">‚Üê</button>
          <div class="chat-header-info">
              <div class="header-app-name">Nearby gappars</div>
          </div>
        </div>
        <div style="padding-top: 24px;">
            <div style="text-align: center; margin-bottom: 20px; padding: 0 24px;">
                <h2 style="color: var(--text-dark); font-family: 'DotGothic16', monospace;">Recommendations</h2>
            </div>
            <input type="text" class="search-bar gradient-border" id="nearbySearchInput" placeholder="Filter by name...">
            <ul class="user-list" id="nearbyUserList">
                <!-- JS will populate this list -->
            </ul>
        </div>
      </div>

      <!-- Search Accounts View -->
      <div id="searchView" class="view find-view hidden">
        <div class="chat-header">
          <button class="back-button gradient-border" id="searchBackBtn">‚Üê</button>
          <div class="chat-header-info">
              <div class="header-app-name">Search Accounts</div>
          </div>
        </div>
        <div style="padding-top: 24px;">
             <div style="text-align: center; margin-bottom: 20px; padding: 0 24px;">
                <h2 style="color: var(--text-dark); font-family: 'DotGothic16', monospace;">Search gappars</h2>
            </div>
            <input type="text" class="search-bar gradient-border" id="accountSearchInput" placeholder="Search by name or location...">
            <ul class="user-list" id="userResultsList">
                <!-- JS will populate this list -->
            </ul>
        </div>
      </div>
    </div>
  </div>
  
  <div class="room-modal" id="roomModal">
    <div class="room-modal-content gradient-border">
      <button class="room-modal-close gradient-border" id="roomModalClose">√ó</button>
      <div class="room-modal-header">
        <h3 class="room-modal-title">Room Manager</h3>
        <p class="room-modal-description">Create or join a private room</p>
      </div>
      <div class="form-group">
        <label class="form-label" for="roomKeyInput">Room Key</label>
        <input type="text" id="roomKeyInput" class="form-input gradient-border" placeholder="Enter room key ( e.g Room123)" maxlength="50">
      </div>
      <div class="room-buttons">
        <button class="btn-room gradient-border" id="joinRoomBtn">Join Room</button>
        <button class="btn-room primary" id="createRoomBtnModal">Create Room</button>
      </div>
      <div class="room-buttons" style="margin-top: 10px;">
        <button class="btn-room gradient-border" id="leaveRoomBtn" style="width: 100%;">Leave Current Room</button>
      </div>
    </div>
  </div>

  <!-- Your existing scripts remain exactly the same -->
  <script>
    function setupMobileKeyboardHandling() {
      if (!('ontouchstart' in window)) return;
      const messageInput = document.getElementById('messageInput');
      const messageList = document.getElementById('messageList');
      let initialViewportHeight = window.innerHeight;
      
      function handleKeyboardShow() {
        document.body.classList.add('keyboard-visible');
        setTimeout(() => {
          if (messageList) {
            messageList.scrollTop = messageList.scrollHeight;
          }
        }, 300);
      }
      
      function handleKeyboardHide() {
        document.body.classList.remove('keyboard-visible');
      }
      
      if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
        if (messageInput) {
          messageInput.addEventListener('focus', () => {
            setTimeout(handleKeyboardShow, 300);
          });
          messageInput.addEventListener('blur', () => {
            setTimeout(handleKeyboardHide, 100);
          });
        }
        
        window.addEventListener('resize', () => {
          const currentHeight = window.innerHeight;
          if (currentHeight < initialViewportHeight * 0.7) {
            handleKeyboardShow();
          } else if (currentHeight > initialViewportHeight * 0.9) {
            handleKeyboardHide();
            initialViewportHeight = currentHeight;
          }
        });
      } else {
        let lastHeight = window.innerHeight;
        const resizeObserver = new ResizeObserver(() => {
          const currentHeight = window.innerHeight;
          const heightDiff = lastHeight - currentHeight;
          if (heightDiff > 150) {
            handleKeyboardShow();
          } else if (heightDiff < -150) {
            handleKeyboardHide();
          }
          lastHeight = currentHeight;
        });
        if (document.body) {
          resizeObserver.observe(document.body);
        }
      }
      
      window.scrollBottom = () => {
        if (messageList) {
          messageList.scrollTop = messageList.scrollHeight;
          if (document.body.classList.contains('keyboard-visible')) {
            setTimeout(() => {
              messageList.scrollTop = messageList.scrollHeight;
            }, 100);
          }
        }
      };
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupMobileKeyboardHandling);
    } else {
      setupMobileKeyboardHandling();
    }
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getFirestore, addDoc, collection, doc, setDoc, onSnapshot, orderBy, query, serverTimestamp, deleteDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyCOmLxxqPesNaBr4Z9fVIU6K2BLW6OsED0",
      authDomain: "gappkar-v1-b3afe.firebaseapp.com",
      databaseURL: "https://gappkar-v1-b3afe-default-rtdb.firebaseio.com",
      projectId: "gappkar-v1-b3afe",
      storageBucket: "gappkar-v1-b3afe.appspot.com",
      messagingSenderId: "726018257415",
      appId: "1:726018257415:web:12142708abdf47952af0a2",
      measurementId: "G-EWK4436NRB"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    let currentUser = null;
    let currentUsername = "";
    let currentUserAge = 0;
    let currentUserLocation = "";
    let userLatitude = null;
    let userLongitude = null;
    let isJoined = false;
    let currentRoom = "global";
    let messagesListener = null;
    let presenceTimer = null;
    let onlineListener = null;
    let currentView = 'joinView';
    
    const $ = (id) => document.getElementById(id);
    
    // Get DOM elements safely
    const allViews = document.querySelectorAll('.view');
    const joinView = $("joinView");
    const chatsView = $("chatsView");
    const messageList = $("messageList");
    const messageInput = $("messageInput");
    const sendButton = $("sendButton");
    const backButton = $("backButton");
    const usernameInput = $("usernameInput");
    const ageInput = $("ageInput");
    const locationInput = $("locationInput");
    const joinButton = $("joinButton");
    const getLocationBtn = $("getLocationBtn");
    const peopleCount = $("peopleCount");
    const createRoomBtnH = $("createRoomBtn");
    const roomModal = $("roomModal");
    const roomModalClose = $("roomModalClose");
    const roomKeyInput = $("roomKeyInput");
    const joinRoomBtn = $("joinRoomBtn");
    const createRoomBtnM = $("createRoomBtnModal");
    const leaveRoomBtn = $("leaveRoomBtn");
    const roomIndicator = $("roomIndicator");

    // Find/Search Elements
    const findBtn = $("findBtn");
    const findAccountsBtn = $("findAccountsBtn");
    const nearbyBtn = $("nearbyBtn");
    const nearbyUserList = $("nearbyUserList");
    const userResultsList = $("userResultsList");
    const accountSearchInput = $("accountSearchInput");
    const nearbySearchInput = $("nearbySearchInput");

    // Enhanced Chat Input Elements
    const expandBtn = $('expandBtn');
    const expandOptions = $('expandOptions');
    const gifOptionBtn = $('gifOptionBtn');
    const audioOptionBtn = $('audioOptionBtn');
    const stickerOptionBtn = $('stickerOptionBtn');
    const stickerPanel = $('stickerPanel');
    const audioPanel = $('audioPanel');
    const gifPanel = $('gifPanel');
    const allFeaturePanels = [stickerPanel, audioPanel, gifPanel].filter(Boolean);
    let currentAudio = null;
    
    const roomMessagesRef = (room) => collection(db, "rooms", room, "messages");
    
    const timeStr = (ts) => {
      const d = ts?.toDate ? ts.toDate() : (ts || new Date());
      let h = d.getHours();
      const m = d.getMinutes().toString().padStart(2, "0");
      const a = h >= 12 ? "PM" : "AM";
      h = h % 12 || 12;
      return `${h}:${m} ${a}`;
    };
    
    const scrollBottom = () => {
      if (messageList) {
        messageList.scrollTop = messageList.scrollHeight;
        if (window.innerWidth <= 480 && document.body.classList.contains('keyboard-visible')) {
          setTimeout(() => {
            messageList.scrollTop = messageList.scrollHeight;
          }, 100);
        }
      }
    };

    // View Management
    function showView(viewId) {
      currentView = viewId;
      allViews.forEach(v => v.classList.add('hidden'));
      const targetView = $(viewId);
      if (targetView) {
        targetView.classList.remove('hidden');
      }
      
      const appHeader = document.querySelector('.app-header');
      if (appHeader) {
        appHeader.style.display = viewId === 'joinView' ? 'block' : 'none';
      }
    }
    
    const updateRoomUI = () => {
      if (!roomIndicator) return;
      roomIndicator.textContent = currentRoom === "global" ? "Global" : currentRoom;
      roomIndicator.style.background = currentRoom === "global" ? "var(--accent-gradient)" : "linear-gradient(135deg, #28a745, #20c997)";
    };
    
    const addSystemMsg = (txt) => {
      if (!messageList) return;
      const div = document.createElement("div");
      div.className = "message system";
      div.innerHTML = `<div class="message-bubble">${txt}</div>`;
      messageList.appendChild(div);
      scrollBottom();
    };
    
    function trackPresence() {
      if (!currentUser || !currentUsername) return;
      const ref = doc(db, "presence", currentUser.uid);
      const data = {
        userId: currentUser.uid, 
        username: currentUsername, 
        location: currentUserLocation,
        age: currentUserAge, 
        room: currentRoom, 
        lastSeen: serverTimestamp(), 
        isOnline: true
      };
      setDoc(ref, data, { merge: true }).catch(console.error);
      clearInterval(presenceTimer);
      presenceTimer = setInterval(() => {
        setDoc(ref, { room: currentRoom, lastSeen: serverTimestamp() }, { merge: true }).catch(console.error);
      }, 30000);
    }
    
    function listenOnlineUsers() {
      if (onlineListener) onlineListener();
      onlineListener = onSnapshot(collection(db, "presence"), (snap) => {
        const fiveAgo = Date.now() - 5 * 60 * 1000;
        let roomCnt = 0;
        snap.forEach(doc => {
          const d = doc.data();
          if (d.lastSeen?.toDate && d.lastSeen.toDate().getTime() > fiveAgo && d.room === currentRoom) {
            roomCnt++;
          }
        });
        if (peopleCount) {
          peopleCount.textContent = `${roomCnt} people ${currentRoom === "global" ? "nearby" : "in " + currentRoom}`;
        }
      }, console.error);
    }

    // Find/Search Logic
    function createUserCard(user) {
      if (user.userId === currentUser?.uid) return '';
      return `
          <li class="user-card gradient-border">
              <img src="https://i.pravatar.cc/150?u=${user.userId}" alt="${user.username}" class="profile-pic">
              <div class="user-info">
                  <h3>${user.username} (${user.age})</h3>
                  <p>üìç ${user.location || 'Unknown'}</p>
              </div>
          </li>
      `;
    }

    function renderUserList(targetList, users) {
      if (!targetList) return;
      if (!users || users.length === 0) {
          targetList.innerHTML = '<p style="text-align:center; color: var(--gray); padding: 20px; font-family: DotGothic16, monospace;">No users found.</p>';
          return;
      }
      targetList.innerHTML = users.filter(u => u.userId !== currentUser?.uid).map(createUserCard).join('');
    }

    async function fetchAllOnlineUsers() {
      const fiveAgo = new Date(Date.now() - 5 * 60 * 1000);
      const q = query(collection(db, "presence"), where("lastSeen", ">", fiveAgo));
      try {
          const snapshot = await getDocs(q);
          return snapshot.docs.map(doc => doc.data());
      } catch (error) {
          console.error("Error fetching users:", error);
          return [];
      }
    }

    // Enhanced Multimedia Message Function  
    async function sendMultimediaMessage(content, type) {
      if (!isJoined || !currentUser) return;
      
      try {
        const messageData = {
          user: currentUsername, 
          timestamp: serverTimestamp(),
          location: currentUserLocation, 
          age: currentUserAge, 
          userId: currentUser.uid
        };

        switch(type) {
          case 'gif':
            messageData.message = '[GIF]';
            messageData.gifUrl = content;
            messageData.isGif = true;
            break;
          case 'sticker':
            messageData.message = '[Sticker]';
            messageData.stickerUrl = content;
            messageData.isSticker = true;
            break;
          case 'audio':
            messageData.message = `[Audio] ${content.name}`;
            messageData.audioUrl = content.url;
            messageData.audioName = content.name;
            messageData.isAudio = true;
            break;
        }

        await addDoc(roomMessagesRef(currentRoom), messageData);
      } catch (e) {
        console.error("Failed to send multimedia:", e);
        addSystemMsg('Failed to send message');
      }
    }
    
    async function getUserLocation() {
      const statusDiv = $("locationStatus");
      if (!statusDiv) return;
      
      if (!navigator.geolocation) {
        statusDiv.textContent = "Geolocation is not supported.";
        statusDiv.className = "error";
        return;
      }
      
      statusDiv.textContent = "Getting your location...";
      statusDiv.className = "";
      
      try {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
        });
        
        userLatitude = position.coords.latitude;
        userLongitude = position.coords.longitude;
        
        try {
          const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${userLatitude}&longitude=${userLongitude}&localityLanguage=en`);
          const data = await response.json();
          const locationName = data.city;
          currentUserLocation = locationName || `${userLatitude.toFixed(2)}, ${userLongitude.toFixed(2)}`;
        } catch (e) {
          currentUserLocation = `${userLatitude.toFixed(2)}, ${userLongitude.toFixed(2)}`;
        }
        
        statusDiv.textContent = `Location found: ${currentUserLocation}`;
        statusDiv.className = "success";
        if (locationInput) {
          locationInput.value = currentUserLocation;
        }
      } catch (error) {
        statusDiv.textContent = "Could not get location. Enter manually.";
        statusDiv.className = "error";
      }
    }
    
    function showModal() {
      if (roomModal) roomModal.classList.add("show");
    }
    
    function hideModal() {
      if (roomModal) roomModal.classList.remove("show");
      if (roomKeyInput) roomKeyInput.value = "";
    }
    
    async function joinRoom(key) {
      const k = key.trim().toLowerCase();
      if (!k) {
        alert("Enter a room key");
        return;
      }
      if (k === currentRoom) {
        hideModal();
        return;
      }
      
      if (messagesListener) messagesListener();
      currentRoom = k;
      localStorage.setItem("gappkar_current_room", currentRoom);
      updateRoomUI();
      if (messageList) messageList.innerHTML = "";
      addSystemMsg(`Joined room: ${currentRoom}`);
      listenMessages();
      trackPresence();
      hideModal();
    }
    
    function leaveRoom() {
      if (currentRoom === "global") {
        hideModal();
        return;
      }
      
      if (messagesListener) messagesListener();
      currentRoom = "global";
      localStorage.removeItem("gappkar_current_room");
      updateRoomUI();
      if (messageList) messageList.innerHTML = "";
      addSystemMsg("Left room, back to global chat");
      listenMessages();
      trackPresence();
      hideModal();
    }
    
    function displayMsg(d) {
      if (!messageList) return;
      
      const mine = d.user === currentUsername;
      const div = document.createElement("div");
      div.className = `message ${mine ? "sent" : "received"}`;
      const time = timeStr(d.timestamp);

      let messageContent = '';

      if (d.isGif && d.gifUrl) {
        messageContent = `<img src="${d.gifUrl}" style="max-width: 250px; border-radius: 16px;">`;
      } else if (d.isSticker && d.stickerUrl) {
        messageContent = `<img src="${d.stickerUrl}" style="max-width: 150px; border-radius: 16px;">`;
      } else if (d.isAudio && d.audioUrl) {
        messageContent = `
          <div style="display: flex; align-items: center; gap: 8px;">
            <button class="chat-audio-play-btn" data-src="${d.audioUrl}">‚ñ∂</button>
            <span>${d.audioName || 'Audio'}</span>
          </div>
        `;
      } else {
        messageContent = d.message || '';
      }

      div.innerHTML = mine
        ? `<div class="message-bubble">${messageContent}<div class="message-time">${time}</div></div>`
        : `<div class="message-info"><div class="sender-name">${d.user}${d.age ? ` (${d.age})` : ""}</div><div class="message-bubble">${messageContent}<div class="message-time">${time}</div></div>${d.location ? `<div class="message-location">üìç ${d.location}</div>` : ""}</div>`;
      
      messageList.appendChild(div);
    }
    
    function listenMessages() {
      if (messagesListener) messagesListener();
      const q = query(roomMessagesRef(currentRoom), orderBy("timestamp", "asc"));
      messagesListener = onSnapshot(q, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
          if (change.type === "added") {
            const temp = messageList?.querySelector('[data-temp="true"]');
            if (temp) temp.remove();
            displayMsg(change.doc.data());
          }
        });
        scrollBottom();
      }, console.error);
    }

    async function sendMessage() {
      if (!messageInput || !messageList) return;
      
      const txt = messageInput.value.trim();
      if (!txt || !isJoined || !currentUser) return;
      
      messageInput.value = "";
      const tempId = `temp_${Date.now()}`;
      const div = document.createElement("div");
      div.className = "message sent";
      div.id = tempId;
      div.dataset.temp = "true";
      div.innerHTML = `<div class="message-bubble">${txt}<div class="message-time" style="opacity: 0.5;">sending...</div></div>`;
      messageList.appendChild(div);
      scrollBottom();
      
      try {
        await addDoc(roomMessagesRef(currentRoom), {
          user: currentUsername, 
          message: txt, 
          timestamp: serverTimestamp(),
          location: currentUserLocation, 
          age: currentUserAge, 
          userId: currentUser.uid
        });
      } catch (e) {
        console.error("Send failed:", e);
        const failedNode = document.getElementById(tempId);
        if (failedNode) {
          const bubble = failedNode.querySelector('.message-bubble');
          const timeEl = failedNode.querySelector('.message-time');
          if (bubble) bubble.style.backgroundColor = '#d32f2f';
          if (timeEl) timeEl.innerText = 'Failed to send!';
        }
      }
    }
    
    async function joinChat(name, age, loc) {
      if (!name.trim()) {
        alert("Enter name");
        return;
      }
      if (age < 13 || age > 99) {
        alert("Age 13-99 only");
        return;
      }
      if (!loc.trim()) {
        alert("Enter location");
        return;
      }
      if (isJoined) return;
      
      try {
        await signInAnonymously(auth);
        currentUsername = name.trim();
        currentUserAge = parseInt(age, 10);
        currentUserLocation = loc.trim();
        isJoined = true;
        
        const savedRoom = localStorage.getItem("gappkar_current_room");
        if (savedRoom) currentRoom = savedRoom;
        
        showView('chatsView');
        document.body.classList.add("chat-active");
        updateRoomUI();
        if (messageList) messageList.innerHTML = "";
        addSystemMsg(`Welcome ${currentUsername}!`);
        
        listenMessages();
        trackPresence();
        listenOnlineUsers();
        
        localStorage.setItem("gappkar_username", currentUsername);
        localStorage.setItem("gappkar_age", currentUserAge.toString());
        localStorage.setItem("gappkar_location", currentUserLocation);
        localStorage.setItem("gappkar_joined", "true");
      } catch (error) {
        console.error("Failed to join chat:", error);
        alert("Failed to join chat. Please try again.");
      }
    }
    
    onAuthStateChanged(auth, (u) => {
      currentUser = u || null;
    });
    
    async function logout() {
      if (presenceTimer) clearInterval(presenceTimer);
      if (onlineListener) onlineListener();
      if (messagesListener) messagesListener();
      
      if (currentUser) {
        try { 
          await deleteDoc(doc(db, "presence", currentUser.uid)); 
        } catch(e) { 
          console.error("Presence cleanup failed:", e);
        }
      }
      
      try { 
        await signOut(auth); 
      } catch (e) {
        console.error("Sign out failed:", e);
      }
      
      isJoined = false;
      currentRoom = "global";
      localStorage.clear();
      showView('joinView');
      document.body.classList.remove("chat-active");
    }

    function handleMainBack() {
      if (['findMenuView', 'nearbyView', 'searchView'].includes(currentView)) {
        showView('chatsView');
      } else {
        logout();
      }
    }

    function handleFindBack() {
      showView('chatsView');
    }

    const sounds = [
      { name: 'Deepak Kalal Foundation', url: 'https://file.garden/aJ-bbmBvGxKiA5vP/Deepak%20kalal%20foundation' },
      { name: 'Thala Ajithkumar', url: 'https://file.garden/aJ-bbmBvGxKiA5vP/Thala%20Ajithkumar.mp3' },
      { name: 'Rajinikanth Updating', url: 'https://file.garden/aJ-bbmBvGxKiA5vP/Rajinikanth%20updating.mp3' },
      { name: 'Modern Bell', url: 'https://file.garden/aJ-bbmBvGxKiA5vP/modern%20Bell.mp3' },
      { name: 'Insuperable Del Risita', url: 'https://file.garden/aJ-bbmBvGxKiA5vP/insuperable%20del%20Risita.mp3' },
    ];

    const togglePanel = (panelToShow) => {
        if (!panelToShow) return;
        const isVisible = panelToShow.classList.contains('visible');
        allFeaturePanels.forEach(p => p && p.classList.remove('visible'));
        if (!isVisible) {
            panelToShow.classList.add('visible');
        }
    };

    const audioList = $('audioList');
    if (audioList) {
      sounds.forEach(sound => {
          const li = document.createElement('li');
          li.className = 'audio-item gradient-border';
          li.innerHTML = `<button class="play-btn">‚ñ∂</button><span class="audio-name">${sound.name}</span>`;
          li.addEventListener('click', (e) => {
              if (e.target.tagName !== 'BUTTON') {
                  sendMultimediaMessage(sound, 'audio');
                  togglePanel(audioPanel);
              }
          });
          const playBtn = li.querySelector('.play-btn');
          if (playBtn) {
            playBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                }
                if (sound.url) {
                    currentAudio = new Audio(sound.url);
                    currentAudio.play().catch(console.error);
                }
            });
          }
          audioList.appendChild(li);
      });
    }

    const GIPHY_API_KEY = 'GLutXRXDEL19PuG3ztekK0JNDr5oySTh';
    let debounceTimer;

    function setupGiphyPanel(type, searchInputId, resultsGridId) {
        const searchInput = $(searchInputId);
        const resultsGrid = $(resultsGridId);
        if (!searchInput || !resultsGrid) return;
        
        const endpoint = type === 'stickers' ? 'stickers' : 'gifs';

        async function fetchItems(searchTerm = '') {
            resultsGrid.innerHTML = '<div class="loader"></div>';
            const url = searchTerm ?
                `https://api.giphy.com/v1/${endpoint}/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(searchTerm)}&limit=24` :
                `https://api.giphy.com/v1/${endpoint}/trending?api_key=${GIPHY_API_KEY}&limit=24`;
            try {
                const res = await fetch(url);
                const { data } = await res.json();
                resultsGrid.innerHTML = '';
                data.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = `${type === 'stickers' ? 'sticker-item' : 'gif-item'} gradient-border`;
                    itemEl.innerHTML = `<img src="${item.images.fixed_width.url}" alt="${item.title}">`;
                    itemEl.onclick = () => {
                        sendMultimediaMessage(item.images.original.url, type === 'stickers' ? 'sticker' : 'gif');
                        togglePanel($(type === 'stickers' ? 'stickerPanel' : 'gifPanel'));
                    };
                    resultsGrid.appendChild(itemEl);
                });
            } catch (e) {
                console.error('Failed to fetch items:', e);
                resultsGrid.innerHTML = `<div>Failed to load ${type}.</div>`;
            }
        }

        searchInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => fetchItems(searchInput.value), 500);
        });
        
        fetchItems();
    }
    
    document.addEventListener("DOMContentLoaded", () => {
      if (localStorage.getItem("gappkar_joined") === "true") {
        const username = localStorage.getItem("gappkar_username") || "";
        const age = parseInt(localStorage.getItem("gappkar_age") || "0", 10);
        const location = localStorage.getItem("gappkar_location") || "";
        if (username && age && location) {
          joinChat(username, age, location);
        }
      }
      
      if (getLocationBtn) getLocationBtn.addEventListener("click", getUserLocation);
      if (joinButton) joinButton.addEventListener("click", () => {
        const username = usernameInput ? usernameInput.value : "";
        const age = ageInput ? ageInput.value : "";
        const location = locationInput ? locationInput.value : "";
        joinChat(username, age, location);
      });
      if (sendButton) sendButton.addEventListener("click", sendMessage);
      if (messageInput) {
        messageInput.addEventListener("keydown", e => { 
          if (e.key === "Enter" && !e.shiftKey) { 
            e.preventDefault(); 
            sendMessage(); 
          } 
        });
      }
      if (backButton) backButton.addEventListener("click", handleMainBack);
      if (createRoomBtnH) createRoomBtnH.addEventListener("click", showModal);
      if (roomModalClose) roomModalClose.addEventListener("click", hideModal);
      if (joinRoomBtn) joinRoomBtn.addEventListener("click", () => {
        const key = roomKeyInput ? roomKeyInput.value : "";
        joinRoom(key);
      });
      if (createRoomBtnM) createRoomBtnM.addEventListener("click", () => {
        const key = roomKeyInput ? roomKeyInput.value : "";
        joinRoom(key);
      });
      if (leaveRoomBtn) leaveRoomBtn.addEventListener("click", leaveRoom);
      if (roomModal) roomModal.addEventListener("click", e => { 
        if (e.target === roomModal) hideModal(); 
      });

      if (findBtn) findBtn.addEventListener('click', () => showView('findMenuView'));
      
      const findMenuBackBtn = $("findMenuBackBtn");
      const nearbyBackBtn = $("nearbyBackBtn");
      const searchBackBtn = $("searchBackBtn");
      
      if (findMenuBackBtn) findMenuBackBtn.addEventListener("click", handleFindBack);
      if (nearbyBackBtn) nearbyBackBtn.addEventListener("click", () => showView('findMenuView'));
      if (searchBackBtn) searchBackBtn.addEventListener("click", () => showView('findMenuView'));

      if (nearbyBtn) {
        nearbyBtn.addEventListener('click', async () => {
          showView('nearbyView');
          if (nearbyUserList) {
            nearbyUserList.innerHTML = '<p style="text-align:center; color: var(--gray); padding: 20px; font-family: DotGothic16, monospace;">Loading users...</p>';
            const allOnlineUsers = await fetchAllOnlineUsers();
            const nearbyUsers = allOnlineUsers.filter(u => u.location && u.location.toLowerCase() === currentUserLocation.toLowerCase());
            renderUserList(nearbyUserList, nearbyUsers.length > 1 ? nearbyUsers : allOnlineUsers);
          }
        });
      }

      if (findAccountsBtn) {
        findAccountsBtn.addEventListener('click', () => {
          showView('searchView');
          renderUserList(userResultsList, []);
        });
      }

      if (accountSearchInput) {
        accountSearchInput.addEventListener('input', async (e) => {
          const searchTerm = e.target.value.toLowerCase();
          if (!searchTerm) {
            renderUserList(userResultsList, []);
            return;
          }
          const allOnlineUsers = await fetchAllOnlineUsers();
          const results = allOnlineUsers.filter(user => 
            (user.username && user.username.toLowerCase().includes(searchTerm)) ||
            (user.location && user.location.toLowerCase().includes(searchTerm))
          );
          renderUserList(userResultsList, results);
        });
      }

      if (expandBtn && expandOptions) {
        expandBtn.addEventListener('click', () => {
            expandBtn.classList.toggle('active');
            expandOptions.classList.toggle('visible');
            if (!expandOptions.classList.contains('visible')) {
                allFeaturePanels.forEach(p => p && p.classList.remove('visible'));
            }
        });
      }

      const setupOptionButton = (btn, panel) => {
          if (!btn || !panel) return;
          btn.addEventListener('click', () => {
               togglePanel(panel);
               if (expandOptions) expandOptions.classList.remove('visible');
               if (expandBtn) expandBtn.classList.remove('active');
          });
      };

      setupOptionButton(stickerOptionBtn, stickerPanel);
      setupOptionButton(audioOptionBtn, audioPanel);
      setupOptionButton(gifOptionBtn, gifPanel);

      document.querySelectorAll('.feature-panel-close-btn').forEach(btn => {
          btn.addEventListener('click', () => {
              const panelId = btn.getAttribute('data-panel');
              const panel = $(panelId);
              if (panel) panel.classList.remove('visible');
          });
      });

      if (messageList) {
        messageList.addEventListener('click', (e) => {
            if (e.target.classList.contains('chat-audio-play-btn')) {
                const audioSrc = e.target.dataset.src;
                if (audioSrc) {
                    if (currentAudio) {
                        currentAudio.pause();
                    }
                    currentAudio = new Audio(audioSrc);
                    currentAudio.play().catch(console.error);
                }
            }
        });
      }

      setupGiphyPanel('gifs', 'gif-search-input', 'gif-results-grid');
      setupGiphyPanel('stickers', 'sticker-search-input', 'stickerGrid');
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = document.getElementById('themeIcon');
      
      function toggleTheme() {
        const body = document.body;
        if (body.getAttribute('data-theme') === 'dark') {
          body.removeAttribute('data-theme');
          if (themeIcon) themeIcon.textContent = 'üåô';
        } else {
          body.setAttribute('data-theme', 'dark');
          if (themeIcon) themeIcon.textContent = '‚òÄÔ∏è';
        }
      }
      
      if (themeToggle) { 
        themeToggle.addEventListener('click', toggleTheme); 
      }
    });
  </script>
</body>
</html>
