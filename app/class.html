<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Information</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Lighter gray background */
        }
        /* Custom styles for a cleaner table design */
        .custom-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 2rem;
        }
        .custom-table th, .custom-table td {
            padding: 1rem;
            text-align: left;
            font-size: 0.9rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .custom-table th {
            background-color: #f8fafc;
            color: #475569;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
         .custom-table thead th:first-child {
            border-top-left-radius: 0.75rem;
        }
        .custom-table thead th:last-child {
            border-top-right-radius: 0.75rem;
        }
         .custom-table tbody tr:last-child td:first-child {
            border-bottom-left-radius: 0.75rem;
        }
        .custom-table tbody tr:last-child td:last-child {
            border-bottom-right-radius: 0.75rem;
        }
        .custom-table tbody tr:hover {
            background-color: #f1f5f9;
        }
        .highlight-text {
            color: #ef4444;
            font-weight: 600;
        }
        .ok-text {
            color: #22c55e;
            font-weight: 600;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header Section -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-lg font-semibold text-gray-700 hover:text-blue-600 transition-colors duration-300">Home</a>
        </nav>
    </header>
    
    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 py-12">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-lg">
            
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Today's Timetable</h2>
            
            <div id="vertical-timetable" class="space-y-4">
                <!-- Timetable will be dynamically generated here -->
                <p class="text-gray-500">Loading today's schedule...</p>
            </div>
            
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mt-12 mb-6">Attendance Record</h2>
            <div class="bg-gray-50 p-4 rounded-xl">
                <div class="overflow-x-auto">
                    <table id="attendance-table" class="custom-table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Subject</th>
                                <th>Classes</th>
                                <th>Present</th>
                                <th>Absent</th>
                                <th>Attendance %</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-tbody" class="bg-white">
                            <!-- Attendance data will be dynamically rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Collapsible Subjects Section -->
            <div id="subjects-section" class="mt-10">
                <div id="toggle-subjects" class="p-4 rounded-xl hover:bg-gray-50 cursor-pointer flex justify-between items-center select-none transition-colors">
                    <h2 class="text-lg font-semibold text-blue-600">
                        View Subjects, Faculty, and Classrooms
                    </h2>
                    <svg id="subjects-arrow" class="w-6 h-6 transform transition-transform text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div id="subjects-content" class="overflow-x-auto hidden transition-all duration-500 mt-4">
                     <div class="bg-gray-50 p-4 rounded-xl">
                        <table class="custom-table bg-white">
                            <thead>
                                <tr>
                                    <th>Code</th><th>Subject</th><th>L-T-P-C</th><th>Faculty(s)</th><th>Classroom(s)</th>
                                </tr>
                            </thead>
                           <tbody id="subjects-tbody">
                                <!-- Subject details will be loaded here -->
                           </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="mt-12 py-6">
        <div class="container mx-auto px-6 text-center text-gray-500"></div>
    </footer>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, writeBatch, getDocs, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDX8H-_OfG4LMbPMji9IJEgHJfanyedEGY",
          authDomain: "goalist-a6573.firebaseapp.com",
          projectId: "goalist-a6573",
          storageBucket: "goalist-a6573.appspot.com",
          messagingSenderId: "850792903925",
          appId: "1:850792903925:web:8bdf55f3de7926b19e81bc",
          measurementId: "G-HZQ897N97C"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let scheduleCache = null;
        let attendanceCache = null;

        // --- DATA FUNCTIONS ---
        const seedInitialData = async (uid) => {
            const batch = writeBatch(db);
            
            // Seed Schedule
            const scheduleRef = collection(db, "users", uid, "classSchedule");
            const defaultSchedule = {
                monday: [{ time: "09:00-09:50", subject: "MGT 286", location: "C 608", code: "MGT286" }, { time: "02:00-02:50", subject: "CSC 202", location: "S 606", code: "CSC202" }, { time: "03:00-03:50", subject: "AEC 108", location: "S 606", code: "AEC108" }, { time: "04:00-05:30", subject: "AEC 108", location: "S 606", code: "AEC108_2" }],
                tuesday: [{ time: "09:00-09:50", subject: "MGT 286", location: "C 608", code: "MGT286" }, { time: "10:00-10:50", subject: "CSC 203", location: "S 606", code: "CSC203" }, { time: "11:00-11:50", subject: "CSC 201", location: "S 606", code: "CSC201" }, { time: "01:00-01:50", subject: "CSC 203 Lab", location: "S 603", code: "CSC203L" }, { time: "02:00-02:50", subject: "CSC 203 Lab", location: "S 603", code: "CSC203L_2" }],
                wednesday: [{ time: "09:00-09:50", subject: "MGT 286", location: "C 608", code: "MGT286" }, { time: "10:00-10:50", subject: "SEC 102", location: "S 414", code: "SEC102" }, { time: "11:00-11:50", subject: "SEC 102", location: "S 414", code: "SEC102_2" }, { time: "01:00-01:50", subject: "CSC 203", location: "S 606", code: "CSC203" }, { time: "02:00-02:50", subject: "CSC 201", location: "S 606", code: "CSC201" }, { time: "03:00-03:50", subject: "CSC 201 Lab", location: "S 606", code: "CSC201L" }, { time: "04:00-05:30", subject: "VAC 104", location: "-", code: "VAC104" }],
                thursday: [{ time: "09:00-09:50", subject: "AEC 108", location: "S 606", code: "AEC108" }, { time: "11:00-11:50", subject: "CSC 203", location: "S 606", code: "CSC203" }, { time: "01:00-01:50", subject: "CSC 202 Lab", location: "X 201", code: "CSC202L" }],
                friday: [{ time: "09:00-09:50", subject: "CSC 201 Lab", location: "C 801", code: "CSC201L" }, { time: "10:00-10:50", subject: "CSC 201 Lab", location: "C 801", code: "CSC201L_2" }, { time: "02:00-02:50", subject: "CSC 202", location: "S 606", code: "CSC202" }]
            };
            batch.set(doc(scheduleRef, "weekly"), defaultSchedule);

            // Seed Subject Info
            const subjectsRef = collection(db, "users", uid, "subjects");
            const subjectDetails = [
                { id: "AEC108", code: "AEC 108", subject: "Problem Solving Skills", ltpc: "1-0-1-2", faculty: "Mr. ISCP00005 (V00005)", rooms: "S 606" },
                { id: "CSC201", code: "CSC 201", subject: "Object Oriented Programming with C++", ltpc: "3-0-1-4", faculty: "Dr. Asit Kumar Das, Dr. Prasant Kumar Mohanty", rooms: "C 801, S 606" },
                { id: "CSC202", code: "CSC 202", subject: "Digital Electronics", ltpc: "3-0-1-4", faculty: "Dr. Jyotibhusan Padhi, Dr. Manoj Kumar Yadav, Dr. Ayoub Sofi", rooms: "S 606, X 201" },
                { id: "CSC203", code: "CSC 203", subject: "Design and Analysis of Algorithms", ltpc: "3-0-1-4", faculty: "Dr. Asit Kumar Das, Dr. Niladri Sett", rooms: "S 603, S 606" },
                { id: "MGT286", code: "MGT 286", subject: "Sales and Relationship Marketing", ltpc: "3-0-0-3", faculty: "Dr. Md Faiz Ahmad", rooms: "C 608" },
                { id: "SEC102", code: "SEC 102", subject: "Digital Literacy", ltpc: "1-0-2-2", faculty: "Dr. Chinmoy Das", rooms: "S 414" },
                { id: "VAC104", code: "VAC 104", subject: "Community Service and Social Responsibility", ltpc: "0-0-2-0", faculty: "-", rooms: "-" }
            ];
            subjectDetails.forEach(sub => batch.set(doc(subjectsRef, sub.id), sub));

            // Seed Attendance
            const attendanceRef = doc(db, "users", uid, "attendance", "summary");
             const defaultAttendance = {
                'AEC 108': { classes: 19, present: 12, absent: 7 }, 'CSC 201': { classes: 34, present: 22, absent: 12 }, 'CSC 202': { classes: 34, present: 27, absent: 7 }, 'CSC 203': { classes: 34, present: 21, absent: 13 }, 'MGT 286': { classes: 24, present: 13, absent: 11 }, 'SEC 102': { classes: 8, present: 6, absent: 2 }, 'VAC 104': { classes: 0, present: 0, absent: 0 }
            };
            batch.set(attendanceRef, defaultAttendance);
            
            await batch.commit();
        };

        const getSchedule = async (uid) => {
            if (scheduleCache) return scheduleCache;
            const docRef = doc(db, "users", uid, "classSchedule", "weekly");
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) {
                await seedInitialData(uid);
                return getSchedule(uid);
            }
            scheduleCache = docSnap.data();
            return scheduleCache;
        };

        const getAttendance = async (uid) => {
             if (attendanceCache) return attendanceCache;
            const docRef = doc(db, "users", uid, "attendance", "summary");
            const docSnap = await getDoc(docRef);
            attendanceCache = docSnap.exists() ? docSnap.data() : {};
            return attendanceCache;
        };

        const getSubjects = async(uid) => {
            const querySnapshot = await getDocs(collection(db, "users", uid, "subjects"));
            return querySnapshot.docs.map(doc => doc.data());
        }

        // --- RENDERING FUNCTIONS ---
        const renderAttendanceRecord = (attendanceData) => {
            const tbody = document.getElementById('attendance-tbody');
            tbody.innerHTML = '';
            for (const subjectName in attendanceData) {
                const data = attendanceData[subjectName];
                const percentage = data.classes > 0 ? ((data.present / data.classes) * 100).toFixed(2) : '0.00';
                const percentageClass = percentage >= 75 ? 'ok-text' : 'highlight-text';
                const row = `<tr><td class="font-semibold text-gray-700">${data.code || subjectName}</td><td>${data.subject}</td><td>${data.classes}</td><td>${data.present}</td><td>${data.absent}</td><td class="${percentageClass} text-center">${percentage}%</td></tr>`;
                const fullAttendanceData = (await getSubjects(userId)).reduce((acc, subj) => {
                    acc[subj.subject] = { ...subj, ...(attendanceData[subj.subject] || { classes: 0, present: 0, absent: 0})};
                    return acc;
                }, {});
                tbody.innerHTML = Object.values(fullAttendanceData).map(data => {
                     const percentage = data.classes > 0 ? ((data.present / data.classes) * 100).toFixed(2) : '0.00';
                     const percentageClass = percentage >= 75 ? 'ok-text' : 'highlight-text';
                     return `<tr><td class="font-semibold text-gray-700">${data.code}</td><td>${data.subject}</td><td>${data.classes}</td><td>${data.present}</td><td>${data.absent}</td><td class="${percentageClass} text-center">${percentage}%</td></tr>`;
                }).join('');
            }
        };

        const renderSubjects = async(uid) => {
            const subjects = await getSubjects(uid);
            const tbody = document.getElementById('subjects-tbody');
            tbody.innerHTML = subjects.map(s => `<tr><td>${s.code}</td><td>${s.subject}</td><td>${s.ltpc}</td><td>${s.faculty}</td><td>${s.rooms}</td></tr>`).join('');
        };
        
        const renderTimetable = async (uid) => {
            userId = uid;
            const schedule = await getSchedule(uid);
            const timetableContainer = document.getElementById('vertical-timetable');
            const dayMap = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const today = new Date();
            const todayString = dayMap[today.getDay()];
            const dateString = today.toISOString().split('T')[0];
            const dailyHistoryRef = doc(db, "users", uid, "dailyAttendance", dateString);
            const dailyHistorySnap = await getDoc(dailyHistoryRef);
            const dailyHistory = dailyHistorySnap.exists() ? dailyHistorySnap.data() : {};

            const todaysClasses = schedule[todayString] || [];
            if (todaysClasses.length === 0) {
                timetableContainer.innerHTML = `<div class="text-center bg-gray-50 rounded-2xl p-8"><p class="text-lg font-semibold text-gray-500">No classes scheduled today.</p></div>`;
                return;
            }

            let html = '';
            for (const cls of todaysClasses) {
                const status = dailyHistory[cls.code] || 'unmarked';
                let statusColorClass = 'border-gray-300';
                if (status === 'attended') statusColorClass = 'border-green-500';
                if (status === 'absent') statusColorClass = 'border-red-500';
                // HTML structure from your provided file
                html += `<div id="class-${cls.code}" class="class-item bg-white rounded-2xl shadow-sm border-l-4 ${statusColorClass} overflow-hidden transition-all duration-300" data-status="${status}"><div class="p-5"><div class="flex flex-col sm:flex-row sm:justify-between sm:items-start"><div><p class="font-bold text-xl text-gray-800">${cls.subject}</p><div class="flex items-center text-gray-500 mt-2 text-sm space-x-4"><span class="flex items-center"><svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>${cls.time}</span><span class="flex items-center"><svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>${cls.location}</span></div></div><div class="mt-4 sm:mt-0 flex items-center justify-end space-x-2 flex-shrink-0"><button class="mark-btn text-sm font-medium py-2 px-4 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors" data-code="${cls.code}" data-subject="${cls.subject}">Mark</button><div class="options hidden" data-code="${cls.code}"><button class="attended-btn text-sm font-medium py-2 px-3 rounded-lg bg-green-500 text-white hover:bg-green-600 flex items-center" data-code="${cls.code}" data-subject="${cls.subject}"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Attended</button><button class="absent-btn text-sm font-medium py-2 px-3 rounded-lg bg-red-500 text-white hover:bg-red-600 flex items-center" data-code="${cls.code}" data-subject="${cls.subject}"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>Absent</button></div></div></div></div></div>`;
            }
            timetableContainer.innerHTML = html;
            addEventListeners();
        };

        // --- LOGIC FUNCTIONS ---
        const markAttendance = async (code, subject, newStatus) => {
            const dateString = new Date().toISOString().split('T')[0];
            const dailyHistoryRef = doc(db, "users", userId, "dailyAttendance", dateString);
            const attendanceSummaryRef = doc(db, "users", userId, "attendance", "summary");
            
            const classItem = document.getElementById(`class-${code}`);
            const previousStatus = classItem.dataset.status;

            if (previousStatus === newStatus) return;

            const attendanceSummary = await getAttendance(userId);
            const record = attendanceSummary[subject];

            if (previousStatus === 'unmarked') {
                if (newStatus === 'attended') record.present++; else record.absent++;
            } else if (previousStatus === 'attended' && newStatus === 'absent') {
                record.present--; record.absent++;
            } else if (previousStatus === 'absent' && newStatus === 'attended') {
                record.absent--; record.present++;
            }

            try {
                const batch = writeBatch(db);
                batch.set(dailyHistoryRef, { [code]: newStatus }, { merge: true });
                batch.set(attendanceSummaryRef, { [subject]: record }, { merge: true });
                await batch.commit();

                attendanceCache = null; // Invalidate cache
                renderDashboard(userId); // Re-render everything
            } catch (e) {
                console.error("Error updating document: ", e);
            }
        };

        const addEventListeners = () => {
            document.querySelectorAll('.mark-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const code = e.target.dataset.code;
                    e.target.classList.add('hidden');
                    document.querySelector(`.options[data-code="${code}"]`).classList.remove('hidden');
                });
            });
            document.querySelectorAll('.attended-btn, .absent-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const { code, subject } = e.currentTarget.dataset;
                    const newStatus = e.currentTarget.classList.contains('attended-btn') ? 'attended' : 'absent';
                    markAttendance(code, subject, newStatus);
                });
            });
        };
        
        const renderDashboard = async (uid) => {
            const attendanceData = await getAttendance(uid);
            await renderTimetable(uid);
            renderAttendanceRecord(attendanceData);
            await renderSubjects(uid);
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const toggleButton = document.getElementById('toggle-subjects');
            const content = document.getElementById('subjects-content');
            const arrow = document.getElementById('subjects-arrow');

            toggleButton.addEventListener('click', () => {
                content.classList.toggle('hidden');
                arrow.classList.toggle('rotate-180');
            });

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    await renderDashboard(userId);
                } else {
                    signInAnonymously(auth).catch((error) => {
                         console.error("Anonymous sign-in failed:", error)
                         document.body.innerHTML = `<div class="flex items-center justify-center h-screen bg-gray-100 text-center p-4"><div class="p-8 bg-white rounded-lg shadow-md"><h1 class="text-2xl font-bold text-red-600 mb-2">Connection Error</h1><p class="text-gray-600">Could not load your tasks. Please ensure you have enabled Anonymous Authentication in your Firebase project's sign-in methods and then refresh the page.</p></div></div>`;
                    });
                }
            });
        });
    </script>
</body>
</html>

